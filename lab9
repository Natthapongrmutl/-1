#include <stdio.h>
#include <stdlib.h>
#include <string.h>

/*
    ข้อมูลนักเรียนที่เก็บใน linked list
*/
struct StudentNode {
    char name[20];
    int age;
    char gender;
    float gpa;
    struct StudentNode* next;
};

class LinkedList {
private:
    StudentNode* head;

public:
    LinkedList() {
        head = NULL;
    }

    ~LinkedList() {
        StudentNode* current = head;

        while (current != NULL) {
            StudentNode* temp = current;
            current = current->next;
            delete temp;
        }
    }

    // เพิ่มข้อมูลนักเรียนใหม่เข้าไปใน linked list
    void insertStudent(char studentName[], int studentAge, char studentGender, float studentGPA) {

        StudentNode* newNode = new StudentNode;

        strcpy(newNode->name, studentName);
        newNode->age = studentAge;
        newNode->gender = studentGender;
        newNode->gpa = studentGPA;

        newNode->next = head;
        head = newNode;
    }

    // หา StudentNode โดยค้นหาจากชื่อ
    StudentNode* findStudent(char studentName[]) {

        StudentNode* current = head;

        while (current != NULL) {

            if (strcmp(current->name, studentName) == 0) {
                return current;
            }

            current = current->next;
        }

        return NULL;
    }

    // ลบข้อมูลนักเรียน โดยค้นหาจากชื่อ
    void deleteStudent(char studentName[]) {

        StudentNode* current = head;
        StudentNode* previous = NULL;

        while (current != NULL) {

            if (strcmp(current->name, studentName) == 0) {

                if (previous == NULL) {
                    head = current->next;
                }
                else {
                    previous->next = current->next;
                }

                delete current;
                printf("Delete successful.\n");
                return;
            }

            previous = current;
            current = current->next;
        }

        printf("Student not found.\n");
    }

    // แก้ไขข้อมูลนักเรียนที่มีอยู่แล้ว โดยค้นหาจากชื่อ
    void editStudent(char studentName[], int newAge, char newGender, float newGPA) {

        StudentNode* target = findStudent(studentName);

        if (target == NULL) {
            printf("Student not found.\n");
            return;
        }

        target->age = newAge;
        target->gender = newGender;
        target->gpa = newGPA;

        printf("Update successful.\n");
    }

    // แสดงข้อมูลทั้งหมดใน linked list
    void displayAll() {

        StudentNode* current = head;

        if (current == NULL) {
            printf("No data available.\n");
            return;
        }

        while (current != NULL) {

            printf("Name: %s | Age: %d | Gender: %c | GPA: %.2f\n",
                   current->name,
                   current->age,
                   current->gender,
                   current->gpa);

            current = current->next;
        }
    }

    StudentNode* getHead() {
        return head;
    }
};

/*
    อ่านข้อมูลจากไฟล์แบบ binary และสร้าง linked list ในหน่วยความจำ
*/
void readFromFile(LinkedList* list) {

    FILE* filePointer = fopen("student.dat", "rb");

    if (filePointer == NULL) {
        return;
    }

    StudentNode temp;

    while (fread(&temp, sizeof(StudentNode), 1, filePointer) == 1) {

        list->insertStudent(
            temp.name,
            temp.age,
            temp.gender,
            temp.gpa
        );
    }

    fclose(filePointer);
}

/*
   เขียนข้อมูลจาก linked list ลงไฟล์แบบ binary
*/
void writeToFile(LinkedList* list) {

    FILE* filePointer = fopen("student.dat", "wb");

    if (filePointer == NULL) {
        printf("Error opening file for writing.\n");
        return;
    }

    StudentNode* current = list->getHead();

    while (current != NULL) {

        fwrite(current, sizeof(StudentNode), 1, filePointer);

        current = current->next;
    }

    fclose(filePointer);
}

void addStudentData(LinkedList* list) {

    char studentName[20];
    int studentAge;
    char studentGender;
    float studentGPA;

    printf("Enter name: ");
    scanf("%s", studentName);

    printf("Enter age: ");
    scanf("%d", &studentAge);

    printf("Enter gender (M/F): ");
    scanf(" %c", &studentGender);

    printf("Enter GPA: ");
    scanf("%f", &studentGPA);

    list->insertStudent(
        studentName,
        studentAge,
        studentGender,
        studentGPA
    );
}

void editStudentData(LinkedList* list) {

    char studentName[20];
    int newAge;
    char newGender;
    float newGPA;

    printf("Enter name to edit: ");
    scanf("%s", studentName);

    printf("Enter new age: ");
    scanf("%d", &newAge);

    printf("Enter new gender (M/F): ");
    scanf(" %c", &newGender);

    printf("Enter new GPA: ");
    scanf("%f", &newGPA);

    list->editStudent(
        studentName,
        newAge,
        newGender,
        newGPA
    );
}

void findStudentData(LinkedList* list) {

    char studentName[20];

    printf("Enter name to search: ");
    scanf("%s", studentName);

    StudentNode* result = list->findStudent(studentName);

    if (result == NULL) {
        printf("Student not found.\n");
        return;
    }

    printf("Found: Name=%s Age=%d Gender=%c GPA=%.2f\n",
           result->name,
           result->age,
           result->gender,
           result->gpa);
}

int main() {

    LinkedList studentList;
    int menuChoice;

    readFromFile(&studentList);

    do {

        printf("\nMenu\n");
        printf("1. Add\n");
        printf("2. Edit\n");
        printf("3. Delete\n");
        printf("4. Find\n");
        printf("5. Show All\n");
        printf("0. Exit\n");
        printf("Select: ");

        scanf("%d", &menuChoice);

        switch (menuChoice) {

            case 1:
                addStudentData(&studentList);
                break;

            case 2:
                editStudentData(&studentList);
                break;

            case 3: {
                char studentName[20];
                printf("Enter name to delete: ");
                scanf("%s", studentName);
                studentList.deleteStudent(studentName);
                break;
            }

            case 4:
                findStudentData(&studentList);
                break;

            case 5:
                studentList.displayAll();
                break;

            case 0:
                printf("Exiting program...\n");
                break;

            default:
                printf("Invalid choice.\n");
        }

    } while (menuChoice != 0);

    writeToFile(&studentList);

    return 0;
}
